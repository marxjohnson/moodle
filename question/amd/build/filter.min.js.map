{"version":3,"file":"filter.min.js","sources":["../src/filter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Question bank filter management.\n *\n * @module     core_question/filter\n * @copyright  2021 Tomo Tsuyuki <tomotsuyuki@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ajax from 'core/ajax';\nimport CoreFilter from 'core/datafilter';\nimport Notification from 'core/notification';\nimport Selectors from 'core/datafilter/selectors';\nimport Templates from 'core/templates';\n\n/**\n * Initialise the question bank filter on the element with the given id.\n *\n * @param {String} filterRegionId id of the filter region\n * @param {String} defaultcourseid default course id\n * @param {String} defaultcategoryid default category id\n * @param {int} perpage number of question per page\n * @param {int} contextId id of the context\n * @param {string} component name of the component for fragment\n * @param {string} callback name of the callback for the fragment\n * @param {string} pagevars name of the callback for the fragment\n * @param {string} extraparams json encoded extra params for the extended apis\n */\nexport const init = (filterRegionId, defaultcourseid, defaultcategoryid,\n                     perpage, contextId, component, callback, pagevars, extraparams) => {\n\n    const filterSet = document.querySelector(`#${filterRegionId}`);\n\n    // Default filter params for WS function.\n    let wsfilter = {\n        // Default value filterset::JOINTYPE_DEFAULT.\n        filters: [],\n        filteroptions: {\n            filterverb: 2,\n        },\n        displayoptions: {\n            perpage: perpage,\n        },\n        sortdata: [\n            {\n                sortby: 'qbank_viewquestiontype\\\\question_type_column',\n                sortorder: 4,\n            }\n        ],\n        defaultcourseid: defaultcourseid,\n        defaultcategoryid: defaultcategoryid,\n    };\n\n    // HTML <div> ID of question container.\n    const SELECTORS = {\n        QUESTION_CONTAINER_ID: '#questionscontainer',\n        SORT_LINK: '#questionscontainer div.sorters a',\n        PAGINATION_LINK: '#questionscontainer a[href].page-link',\n    };\n\n    // Init function with apply callback.\n    const coreFilter = new CoreFilter(filterSet, function(filters, pendingPromise) {\n        applyFilter(filters, pendingPromise);\n    });\n    coreFilter.init();\n\n    /**\n     * Ajax call to retrieve question via ws functions\n     *\n     * @param {Object} filter filter object\n     * @returns {*}\n     */\n    const requestQuestions = filter => {\n        const request = {methodname: 'core_question_filter', args: filter};\n        return ajax.call([request])[0];\n    };\n\n    /**\n     * Retrieve table data.\n     *\n     * @param {Object} filterdata data\n     * @param {Promise} pendingPromise pending promise\n     */\n    const applyFilter = (filterdata, pendingPromise) => {\n        // Getting filter data.\n        // Otherwise, the ws function should retrieves question based on default courseid and cateogryid.\n        if (filterdata) {\n            // Main join types.\n            wsfilter.filteroptions.filterverb = parseInt(filterSet.dataset.filterverb, 10);\n            // Clean old filter\n            wsfilter.filters = [];\n\n            // Retrieve fitter info.\n            for (const [key, value] of Object.entries(filterdata)) {\n                let filter = {\n                    'filtertype': key,\n                    'conditionclass': value.conditionclass,\n                    'jointype': value.jointype,\n                    'rangetype': value.rangetype,\n                    'values': value.values.toString()\n                };\n                wsfilter.filters.push(filter);\n            }\n            if (Object.keys(filterdata).length !== 0) {\n                updateUrlParams(filterdata);\n            }\n        }\n        // Load questions for first page.\n        requestQuestions(wsfilter)\n            .then((response) => {\n                // Cleans any notifications if not needed.\n                let element = document.getElementById('user-notifications');\n                while (element.firstChild) {\n                    element.removeChild(element.firstChild);\n                }\n                if (response.warnings[0] !== undefined) {\n                    if (response.warnings[0].warningcode === 'nocategoryconditionspecified') {\n                        Notification.addNotification({\n                            message: response.warnings[0].message,\n                            type: 'info'\n                          });\n                    }\n                }\n                return renderQuestiondata(response.filtercondition);\n            })\n            // Render questions for first page and pagination.\n            .then((response) => {\n                const questionscontainer = document.querySelector(SELECTORS.QUESTION_CONTAINER_ID);\n                if (response.questionhtml === undefined) {\n                    response.questionhtml = '';\n                }\n                if (response.jsfooter === undefined) {\n                    response.jsfooter = '';\n                }\n                Templates.replaceNodeContents(questionscontainer, response.questionhtml, response.jsfooter);\n                // Resolve filter promise.\n                if (pendingPromise) {\n                    pendingPromise.resolve();\n                }\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Render question data using the fragment.\n     * @param {object} filtercondition\n     * @return {*}\n     */\n    const renderQuestiondata = (filtercondition) => {\n        const viewData = {\n            component: component,\n            callback: callback,\n            filtercondition: filtercondition,\n            contextid: contextId,\n            extraparams: extraparams,\n        };\n        const request = {methodname: 'core_question_view', args: viewData};\n        return ajax.call([request])[0];\n    };\n\n    /**\n     * Update URL Param based upon the current filter.\n     *\n     * @param {Object} filters Active filters.\n     */\n    const updateUrlParams = (filters) => {\n        const url = new URL(location.href);\n        const query = objectToQuery(filters);\n        url.searchParams.set('filter', query);\n        history.pushState(filters, '', url);\n    };\n\n    /**\n     * Convert a nested object into query parameters.\n     *\n     * @param {Object} filters Active filters.\n     * @return {String}\n     */\n    const objectToQuery = (filters) => {\n        return Object.keys(filters).map(key => {\n            let value = filters[key];\n            if (value !== null && typeof value === 'object') {\n                value = objectToQuery(value);\n            }\n            return `${key}=${encodeURIComponent(`${value}`.replace(/\\s/g, '_'))}`;\n        }).join('&');\n    };\n\n    /**\n     * Load URL parameter.\n     *\n     * @return {Object} filters\n     */\n    const loadUrlParams = () => {\n        const queryString = location.search;\n        const urlParams = new URLSearchParams(queryString);\n        if (urlParams.has('filter')) {\n            const filters = queryToObject(urlParams.get('filter'));\n            return filters;\n        }\n        return {};\n    };\n\n    /**\n     * Convert query parameters into object.\n     *\n     * @param {string} query Query representing filter object.\n     * @return {object}\n     */\n    const queryToObject = (query) => {\n        const object = {};\n        const params = new URLSearchParams(query);\n        const entries = params.entries();\n        entries.forEach((value) => {\n            const param = value[0];\n            object[param] = !isNaN(params.get(param)) ? parseInt(params.get(param)) : params.get(param);\n            if (isNaN(object[param]) && object[param].includes('&')) {\n                object[param] = queryToObject(object[param]);\n            }\n            if (param == 'values') {\n                if (typeof object[param] == 'string' && object[param].includes('=')) {\n                    object[param] = [object[param].split('=')[1]];\n                } else if (typeof object[param] == 'number') {\n                    object[param] = [object[param]];\n                } else {\n                    object[param] = Object.values(object[param]);\n                }\n            }\n        });\n        return object;\n    };\n\n    // Run apply filter at page load.\n    pagevars = JSON.parse(pagevars);\n    let initialFilters;\n    if (pagevars.filters) {\n        // Load initial filter based on page vars.\n        initialFilters = pagevars.filters;\n    } else {\n        // Otherwise, load filter from URL.\n        initialFilters = loadUrlParams();\n    }\n\n    if (Object.entries(initialFilters).length !== 0) {\n        // Remove the default empty filter row.\n        const emptyFilterRow = filterSet.querySelector(Selectors.filterset.regions.emptyFilterRow);\n        if (emptyFilterRow) {\n            emptyFilterRow.remove();\n        }\n\n        // Add fitlers.\n        let rowcount = 0;\n        for (const urlFilter in initialFilters) {\n            if (urlFilter !== 'courseid') {\n                // Add each filter row.\n                rowcount += 1;\n                const filterdata = {\n                    filtertype: urlFilter,\n                    values:  initialFilters[urlFilter].values,\n                    jointype: initialFilters[urlFilter].jointype,\n                    rangetype: initialFilters[urlFilter].rangetype,\n                    rownum: rowcount\n                };\n                coreFilter.addFilterRow(filterdata);\n            }\n        }\n\n        // Apply filter.\n        applyFilter(initialFilters);\n    }\n};\n"],"names":["filterRegionId","defaultcourseid","defaultcategoryid","perpage","contextId","component","callback","pagevars","extraparams","filterSet","document","querySelector","wsfilter","filters","filteroptions","filterverb","displayoptions","sortdata","sortby","sortorder","SELECTORS","coreFilter","CoreFilter","pendingPromise","applyFilter","init","filterdata","parseInt","dataset","key","value","Object","entries","filter","conditionclass","jointype","rangetype","values","toString","push","keys","length","updateUrlParams","request","methodname","args","ajax","call","requestQuestions","then","response","element","getElementById","firstChild","removeChild","undefined","warnings","warningcode","addNotification","message","type","renderQuestiondata","filtercondition","questionscontainer","questionhtml","jsfooter","replaceNodeContents","resolve","fail","Notification","exception","contextid","url","URL","location","href","query","objectToQuery","searchParams","set","history","pushState","map","encodeURIComponent","replace","join","queryToObject","object","params","URLSearchParams","forEach","param","isNaN","get","includes","split","initialFilters","JSON","parse","queryString","search","urlParams","has","loadUrlParams","emptyFilterRow","Selectors","filterset","regions","remove","rowcount","urlFilter","filtertype","rownum","addFilterRow"],"mappings":"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"}