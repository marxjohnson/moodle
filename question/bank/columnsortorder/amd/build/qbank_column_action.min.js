define("qbank_columnsortorder/qbank_column_action",["exports","core/notification","core/str","qbank_columnsortorder/repository","jquery","core/modal_events","core/modal_factory","core/templates","core/sortable_list"],(function(_exports,_notification,_str,repository,_jquery,_modal_events,_modal_factory,_templates,_sortable_list){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Setting up resize, pin, move, and show/hide actions for the specified table
   * Columns on the same header should have same data id attribute as to identify if a column belong to a header.
   *
   *
   * @module     qbank_columnsortorder/qbank_column_action
   * @copyright  2022 Catalyst IT Australia Pty Ltd
   * @author     Nathan Nguyen <nathannguyen@catalyst-ca.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let table,dataIdAttribute,dataNameAttribute,currentHeader,currentX;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireWildcard(_notification),repository=_interopRequireWildcard(repository),_jquery=_interopRequireDefault(_jquery),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_templates=_interopRequireDefault(_templates),_sortable_list=_interopRequireDefault(_sortable_list);const SELECTORS_MOVE_HANDLE='[data-action="move"]',SELECTORS_RESIZE_HANDLE='[data-action="resize"]',SELECTORS_tableHeader=identifier=>"th[data-".concat(dataIdAttribute,'="').concat(identifier.replace(/["\\]/g,"\\$&"),'"]'),SELECTORS_tableColumn=identifier=>"td[data-".concat(dataIdAttribute,'="').concat(identifier.replace(/["\\]/g,"\\$&"),'"]'),SELECTORS_tableHeaderSection=tableid=>"#".concat(tableid," thead tr"),addHandle=(context,container)=>_templates.default.renderForPromise("qbank_columnsortorder/action_handle",context).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents(container,html,js),container})),getColumnOrder=()=>{const tableHeaders=table.querySelectorAll("th"),columns=Array.from(tableHeaders).map((column=>column.dataset[dataIdAttribute]));return columns.filter(((value,index)=>columns.indexOf(value)===index))},setUpMoveHandle=function(handleContainer){let component=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const tableHeaders=table.querySelectorAll("th:not(.checkbox)");tableHeaders.forEach((async header=>{const context={action:"move",target:header.dataset[dataIdAttribute],title:await(0,_str.get_string)("movecolumn","qbank_columnsortorder",header.dataset[dataNameAttribute]),pixicon:"i/dragdrop",pixcomponent:"core",popup:!0},container=header.querySelector(handleContainer);addHandle(context,container).catch((ex=>(0,_notification.exception)(ex)))}));const headerSectionSelector=SELECTORS_tableHeaderSection(table.id),headerSection=(0,_jquery.default)(headerSectionSelector);new _sortable_list.default(headerSectionSelector,{moveHandlerSelector:SELECTORS_MOVE_HANDLE,isHorizontal:!0}),headerSection.on(_sortable_list.default.EVENTS.DRAGSTART,(event=>{event.target.classList.contains("header")&&event.target.classList.add("active")})),headerSection.on(_sortable_list.default.EVENTS.DRAGEND,(event=>{event.target.classList.contains("active")&&event.target.classList.remove("active")})),headerSection.on(_sortable_list.default.EVENTS.DROP,(event=>{const header=event.target,insertAfter=header.previousElementSibling;table.querySelectorAll(SELECTORS_tableColumn(header.dataset[dataIdAttribute])).forEach((column=>{const row=column.parentElement;if(insertAfter){row.querySelector(SELECTORS_tableColumn(insertAfter.dataset[dataIdAttribute])).after(column)}else row.insertBefore(column,row.firstChild)})),repository.setColumnbankOrder(getColumnOrder(),component).catch(_notification.default.exception)}))},saveColumnSizes=()=>{let columnSizes=[];return table.querySelectorAll("th").forEach((header=>{let size={column:header.dataset[dataIdAttribute],width:header.style.width};columnSizes.push(size)})),JSON.stringify(columnSizes)},showResizeModal=async function(currentHeader){let component=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const initialWidth=currentHeader.offsetWidth,modal=await _modal_factory.default.create({title:(0,_str.get_string)("resizecolumn","qbank_columnsortorder",currentHeader.textContent),type:_modal_factory.default.types.SAVE_CANCEL,body:_templates.default.render("qbank_columnsortorder/resize_modal",{})}),root=modal.getRoot();root.on(_modal_events.default.cancel,(()=>{currentHeader.style.width=initialWidth+"px"})),root.on(_modal_events.default.save,(()=>{repository.setColumnSize(saveColumnSizes(),component).catch(_notification.default.exception)})),modal.show();const body=await modal.bodyPromise,input=body.get(0).querySelector("input");input.value=initialWidth,input.addEventListener("change",(e=>{const newWidth=e.target.value;currentHeader.style.width=newWidth+"px"}))},setUpResizeHandle=(handleContainer,component)=>{table.querySelectorAll("th:not(.checkbox)").forEach((async header=>{const context={action:"resize",target:header.dataset[dataIdAttribute],title:await(0,_str.get_string)("resizecolumn","qbank_columnsortorder",header.dataset[dataNameAttribute]),pixicon:"resizehandle",pixcomponent:"qbank_columnsortorder",popup:!0},container=header.querySelector(handleContainer);addHandle(context,container)}));let moveTracker=!1,currentResizeHandle=null;table.addEventListener("mousedown",(e=>{if(currentResizeHandle=e.target.closest(SELECTORS_RESIZE_HANDLE),!currentResizeHandle)return;currentX=e.pageX;const target=currentResizeHandle.dataset.target;currentHeader=table.querySelector(SELECTORS_tableHeader(target)),moveTracker=!1})),document.addEventListener("mousemove",(e=>{if(!currentHeader||!currentResizeHandle||0===currentX)return;document.getSelection().removeAllRanges();const offset=e.pageX-currentX;currentX=e.pageX;const newWidth=currentHeader.offsetWidth+offset;currentHeader.style.width=newWidth+"px",moveTracker=!0})),document.addEventListener("mouseup",(()=>{currentHeader&&currentResizeHandle&&0!==currentX&&(moveTracker?repository.setColumnSize(saveColumnSizes(),component).catch(_notification.default.exception):showResizeModal(currentHeader,component),currentHeader=null,currentResizeHandle=null,currentX=0,moveTracker=!1)})),table.addEventListener("keypress",(e=>{if("Enter"!==e.key&&" "!==e.key)return;const resizeHandle=e.target.closest(SELECTORS_RESIZE_HANDLE);if(!resizeHandle)return;e.preventDefault(),e.stopPropagation();const target=resizeHandle.dataset.target,currentHeader=table.querySelector(SELECTORS_tableHeader(target));showResizeModal(currentHeader,component)}))},setUpHideShowDropdown=async function(dropdownContainer){let component=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const container=document.querySelector(dropdownContainer);let currentHiddenColumns=table.dataset.hiddencolumns;currentHiddenColumns&&(currentHiddenColumns=JSON.parse(currentHiddenColumns));let context={columns:[],text:await(0,_str.get_string)("showhidecolumn","qbank_columnsortorder"),id:"showhidecolumn"};const tableHeaders=table.querySelectorAll("th:not(.checkbox)");return tableHeaders.forEach((header=>{const visible=!currentHiddenColumns||!currentHiddenColumns.includes(header.dataset[dataIdAttribute]),column={id:header.dataset[dataIdAttribute],name:header.dataset[dataNameAttribute],checked:visible};context.columns.push(column)})),_templates.default.renderForPromise("qbank_columnsortorder/showhide_dropdown",context).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(container,html,js),addDropdownEventListeners(container,component),container}))},toggleColumnHandler=function(checkbox,container){let component=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const target=checkbox.value,header=table.querySelector(SELECTORS_tableHeader(target));if(!0===checkbox.checked){header.style.display="";table.querySelectorAll(SELECTORS_tableColumn(target)).forEach((column=>{column.style.display=""}))}else{header.style.display="none";table.querySelectorAll(SELECTORS_tableColumn(target)).forEach((column=>{column.style.display="none"}))}const checkboxes=container.querySelectorAll("input[type=checkbox]"),hiddenColumns=[...checkboxes].filter((checkbox=>!checkbox.checked)).map((checkbox=>checkbox.value));repository.setHiddenColumns(hiddenColumns,component).catch(_notification.default.exception)},addDropdownEventListeners=function(container){let component=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";container.addEventListener("click",(event=>{const item=event.target.closest(".dropdown-item");item&&toggleColumnHandler(item.querySelector("input[type=checkbox]"),container,component)})),container.addEventListener("keydown",(event=>{const item=event.target.closest(".dropdown-item");if("Enter"===event.key){if(!item)return;const checkbox=item.querySelector("input[type=checkbox]");checkbox.checked=!checkbox.checked,toggleColumnHandler(checkbox,container,component)}else{if("ArrowUp"!==event.key&&"ArrowDown"!==event.key)return;{const item=event.target.closest(".dropdown-item");let target=event.currentTarget.querySelector(".dropdown-item:first-of-type");var _item$previousElement,_item$nextElementSibl;if(item)if("ArrowUp"===event.key)target=null!==(_item$previousElement=item.previousElementSibling)&&void 0!==_item$previousElement?_item$previousElement:event.currentTarget.querySelector(".dropdown-item:last-of-type");else target=null!==(_item$nextElementSibl=item.nextElementSibling)&&void 0!==_item$nextElementSibl?_item$nextElementSibl:event.currentTarget.querySelector(".dropdown-item:first-of-type");target.querySelector("input[type=checkbox]").focus(),event.preventDefault()}}}))},setUpCurrentHiddenColumns=()=>{let currentHiddenColumns=table.dataset.hiddencolumns;currentHiddenColumns&&(currentHiddenColumns=JSON.parse(currentHiddenColumns)),currentHiddenColumns.length>0&&currentHiddenColumns.forEach((pluginname=>{if(!pluginname)return;table.querySelector(SELECTORS_tableHeader(pluginname)).style.display="none";table.querySelectorAll(SELECTORS_tableColumn(pluginname)).forEach((cell=>{cell.style.display="none"}))}))},setUpCurrentColumnSizes=()=>{const currentColumnSizes=table.dataset.colsize;let decodedSizes=[];currentColumnSizes&&(decodedSizes=JSON.parse(currentColumnSizes),Array.isArray(decodedSizes)||(decodedSizes=[]));table.querySelectorAll("th").forEach((header=>{const colSize=decodedSizes.find((colSize=>colSize.column===header.dataset.pluginname));colSize&&""!==colSize.width?header.style.width=colSize.width:header.style.width=header.offsetWidth+"px"})),table.style.width="min-content"},setUpTable=id=>{if(table=document.getElementById(id),"true"==table.dataset.setup)return!1;dataIdAttribute="pluginname",dataNameAttribute="name";const tableHeaders=table.querySelectorAll("th");return table.querySelectorAll("tr").forEach((row=>{const columns=row.querySelectorAll("td");for(let i=0;i<columns.length;i++)columns[i].dataset[dataIdAttribute]=tableHeaders[i].dataset[dataIdAttribute]})),table.dataset.setup="true",!0};_exports.init=function(tableId,isEditing){let component=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";setUpTable(tableId)&&(setUpCurrentHiddenColumns(),setUpCurrentColumnSizes(),isEditing&&(setUpHideShowDropdown("#show-hide-dropdown",component).catch(_notification.default.exception),setUpMoveHandle(".move-handle",component),setUpResizeHandle(".resize-handle",component)))}}));

//# sourceMappingURL=qbank_column_action.min.js.map