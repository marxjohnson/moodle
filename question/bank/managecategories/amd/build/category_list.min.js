define("qbank_managecategories/category_list",["exports","core/ajax","core/fragment","core/notification","core/pending","core/templates","core/modal","core/str"],(function(_exports,_ajax,_fragment,_notification,_pending,_templates,_modal,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Javascript module handling ordering of categories.
   *
   * @module     qbank_managecategories
   * @copyright  2021 Catalyst IT Australia Pty Ltd
   * @author     Ghaly Marc-Alexandre <marc-alexandreghaly@catalyst-ca.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   *
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),_templates=_interopRequireDefault(_templates),_modal=_interopRequireDefault(_modal);const SELECTORS_CATEGORY_LIST=".qbank_managecategories-categorylist",SELECTORS_MODAL_CATEGORY_ITEM=".modal_category_item[data-categoryid]",SELECTORS_CATEGORY_RENDERED="#categoriesrendered",SELECTORS_ACTIONABLE_ELEMENT='a, [role="button"], [role="menuitem"]',SELECTORS_SHOW_DESCRIPTION_CHECKBOX='[name="qbshowdescr"]',SELECTORS_MOVE_CATEGORY_MENU_ITEM='[role="menuitem"][data-actiontype="move"]',SELECTORS_LIST_ITEM=".qbank_managecategories-item[data-categoryid]",SELECTORS_CONTEXT=".qbank_managecategories-categorylist[data-contextid]",SELECTORS_NOT_DRAGGABLE="[draggable=false]",getCategoriesFragment=contextid=>{let params={url:location.href};return _fragment.default.loadFragment("qbank_managecategories","categories",contextid,params)},setCatOrder=function(originCategory,targetCategory,isBeforeTarget,pageContextId){let pendingPromise=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const call={methodname:"qbank_managecategories_update_category_order",args:{categoryid:originCategory,targetcategoryid:targetCategory,isbeforetarget:isBeforeTarget}};_ajax.default.call([call])[0].then((()=>getCategoriesFragment(pageContextId))).catch((error=>{var _document$getElements;return _notification.default.addNotification({message:error.message,type:"error"}),null===(_document$getElements=document.getElementsByClassName("alert-danger")[0])||void 0===_document$getElements||_document$getElements.scrollIntoView(),getCategoriesFragment(pageContextId)})).then(((html,js)=>{_templates.default.replaceNode("#categoriesrendered",html,js),pendingPromise&&pendingPromise.resolve()})).catch((error=>{pendingPromise&&pendingPromise.reject(error),_notification.default.exception(error)}))},createMoveCategoryList=(item,movingCategory)=>{const categories=[];return item.children&&item.children.forEach((category=>{let child={categoryid:category.dataset.categoryid,categoryname:category.dataset.categoryname,categories:null,firstchild:category===item.children[0],current:category.dataset.categoryid===movingCategory};const childList=category.querySelector(SELECTORS_CATEGORY_LIST);childList&&(child.categories=createMoveCategoryList(childList,movingCategory)),categories.push(child)})),categories};_exports.init=pagecontextid=>{var pageContextId;pageContextId=pagecontextid,document.querySelector(SELECTORS_CATEGORY_RENDERED).addEventListener("click",(e=>{if(!e.target.closest(SELECTORS_CATEGORY_RENDERED))return;const actionIcon=e.target.closest(".action-icon");if(!actionIcon)return;e.preventDefault();const data=actionIcon.dataset;let call;const targetParent=document.querySelector("#category-".concat(data.tocategory));if(targetParent){const childList=targetParent.querySelector(SELECTORS_CATEGORY_LIST);call=childList?{methodname:"qbank_managecategories_update_category_order",args:{categoryid:data.tomove,targetcategoryid:childList.lastElementChild.dataset.categoryid,isbeforetarget:!1}}:{methodname:"qbank_managecategories_move_category_to_new_parent",args:{categoryid:data.tomove,newparentcategoryid:data.tocategory}}}else{const currentParent=actionIcon.closest(SELECTORS_CATEGORY_LIST).closest(SELECTORS_LIST_ITEM);call={methodname:"qbank_managecategories_update_category_order",args:{categoryid:data.tomove,targetcategoryid:currentParent.dataset.categoryid,isbeforetarget:!1}}}_ajax.default.call([call])[0].then((()=>getCategoriesFragment(pageContextId))).then(((html,js)=>{_templates.default.replaceNode(SELECTORS_CATEGORY_RENDERED,html,js)})).catch(_notification.default.exception)})),(pagecontextid=>{let categoryid,dragProxy,touchTimeout,touchScrollInterval;const getTouchTarget=e=>document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY).closest(SELECTORS_LIST_ITEM),getInsertBefore=(event,dropTarget)=>(event.changedTouches?event.changedTouches[0].clientY:event.clientY)-dropTarget.getBoundingClientRect().top<dropTarget.clientHeight/2,clearTargetIndicators=()=>{const dropTarget=document.querySelector(".qbank_managecategories-category-droptarget");dropTarget&&dropTarget.classList.remove("qbank_managecategories-category-droptarget");const dropTargetBefore=document.querySelector(".qbank_managecategories-category-droptarget-before");dropTargetBefore&&dropTargetBefore.classList.remove("qbank_managecategories-category-droptarget-before")},handleDragStart=e=>{var _target$dataset;const target=e.target.closest(SELECTORS_LIST_ITEM);target&&!e.target.closest(SELECTORS_NOT_DRAGGABLE)&&(categoryid=null===(_target$dataset=target.dataset)||void 0===_target$dataset?void 0:_target$dataset.categoryid,"touchstart"===e.type&&(touchTimeout=void 0,makeDragProxy(e,target)))},makeDragProxy=(event,element)=>{dragProxy&&(dragProxy.remove(),dragProxy=null),dragProxy=document.createElement("div"),dragProxy.id="qbank_managecategories-dragproxy",dragProxy.classList.add("editing"),dragProxy.style.width=element.getBoundingClientRect().width+"px",dragProxy.style.height=element.getBoundingClientRect().height+"px",dragProxy.style.top=Math.round(event.touches[0].clientY)+"px",dragProxy.style.left=Math.round(event.touches[0].clientX)+"px",dragProxy.innerHTML=element.innerHTML,document.body.appendChild(dragProxy)},handleDrag=e=>{let target;if("touchmove"===e.type){if("number"==typeof touchTimeout)return clearTimeout(touchTimeout),void(touchTimeout=void 0);target=getTouchTarget(e),touchMoveScroll(e),dragProxy&&(dragProxy.style.top=Math.round(e.changedTouches[0].clientY)+"px",dragProxy.style.left=Math.round(e.changedTouches[0].clientX)+"px")}else target=e.target.closest(SELECTORS_LIST_ITEM);if(!target||!categoryid)return;if(target.closest('[data-categoryid="'.concat(categoryid,'"]')))return;const insertBefore=getInsertBefore(e,target);if(clearTargetIndicators(),insertBefore&&target===target.parentElement.firstElementChild)return void target.classList.add("qbank_managecategories-category-droptarget-before");if(!insertBefore&&target===target.parentElement.lastElementChild)return void target.classList.add("qbank_managecategories-category-droptarget");const insertTarget=insertBefore?target:target.nextElementSibling;insertTarget&&insertTarget.classList.add("qbank_managecategories-category-droptarget-before")},handleDragEnd=e=>{let target;const pending=new _pending.default("qbank_managecategories/dragend");if(clearTargetIndicators(),"touchend"===e.type){if("number"==typeof touchScrollInterval&&(window.clearInterval(touchScrollInterval),touchScrollInterval=void 0),"number"==typeof touchTimeout)return window.clearTimeout(touchTimeout),void(touchTimeout=void 0);dragProxy&&(dragProxy.remove(),dragProxy=null),target=getTouchTarget(e)}else target=e.target.closest(SELECTORS_LIST_ITEM);if(!target){const listTarget=e.target.closest(SELECTORS_CATEGORY_LIST);listTarget&&(target=getInsertBefore(e,listTarget)?listTarget.firstElementChild:listTarget.lastElementChild)}if(!target||!categoryid)return;const source=document.getElementById("category-".concat(categoryid));if(!source)return;let targetCategory;e.preventDefault(),categoryid=null;const insertBefore=getInsertBefore(e,target);let before=insertBefore;if(insertBefore&&target===target.parentElement.firstElementChild)targetCategory=target.dataset.categoryid,target.closest(SELECTORS_CATEGORY_LIST).insertBefore(source,target);else if(insertBefore||target!==target.parentElement.lastElementChild){const insertTarget=insertBefore?target:target.nextElementSibling;targetCategory=insertTarget.dataset.categoryid,before=!0,target.closest(SELECTORS_CATEGORY_LIST).insertBefore(source,insertTarget)}else targetCategory=target.dataset.categoryid,target.closest(SELECTORS_CATEGORY_LIST).appendChild(source);const originCategory=source.dataset.categoryid;setCatOrder(originCategory,targetCategory,before,pagecontextid,pending)},touchMoveScroll=e=>{if(!categoryid)return;const intervalRunning=void 0!==touchScrollInterval;e.changedTouches[0].clientY<50&&!intervalRunning?touchScrollInterval=window.setInterval((()=>{window.scrollBy(0,-1)}),5):window.innerHeight-e.changedTouches[0].clientY<50&&!intervalRunning?touchScrollInterval=window.setInterval((()=>{window.scrollBy(0,1)}),5):intervalRunning&&(window.clearInterval(touchScrollInterval),touchScrollInterval=void 0)},allowDrop=e=>{e.preventDefault()},categoryRoot=document.getElementById("categoriesrendered");categoryRoot.addEventListener("dragover",allowDrop),categoryRoot.addEventListener("dragenter",allowDrop),categoryRoot.addEventListener("dragstart",handleDragStart),categoryRoot.addEventListener("dragenter",handleDrag),categoryRoot.addEventListener("dragleave",(e=>{e.target.classList.contains("qbank_managecategories-categorylist")&&clearTargetIndicators()})),categoryRoot.addEventListener("drop",handleDragEnd),categoryRoot.addEventListener("touchmove",handleDrag,!1),categoryRoot.addEventListener("touchend",handleDragEnd,!1),categoryRoot.addEventListener("touchstart",(e=>{touchTimeout=window.setTimeout((()=>handleDragStart(e)),500)}),!1),document.querySelectorAll(SELECTORS_LIST_ITEM+" "+SELECTORS_ACTIONABLE_ELEMENT).forEach((element=>{element.setAttribute("draggable",!1)}))})(pagecontextid),document.addEventListener("click",(e=>{const checkbox=e.target.closest(SELECTORS_SHOW_DESCRIPTION_CHECKBOX);checkbox&&checkbox.form.submit()})),(pagecontextid=>{document.querySelector(SELECTORS_CATEGORY_RENDERED).addEventListener("click",(async e=>{const item=e.target.closest(SELECTORS_MOVE_CATEGORY_MENU_ITEM);if(!item)return;if(item.getAttribute("aria-disabled"))return;item.setAttribute("aria-disabled",!0);let moveList={contexts:[]};document.querySelectorAll(SELECTORS_CONTEXT).forEach((context=>{const moveContext={contextname:context.dataset.contextname,categories:[],hascategories:!1};moveContext.categories=createMoveCategoryList(context,item.dataset.categoryid),moveContext.hascategories=moveContext.categories.length>0,moveList.contexts.push(moveContext)}));const modal=await _modal.default.create({title:(0,_str.get_string)("movecategory","qbank_managecategories",item.dataset.categoryname),body:_templates.default.render("qbank_managecategories/move_context_list",moveList),footer:"",show:!0,large:!0});modal.getBody()[0].addEventListener("click",(e=>{const target=e.target.closest(SELECTORS_MODAL_CATEGORY_ITEM);if(!target)return;const pending=new _pending.default("qbank_managecategories/modal");setCatOrder(item.dataset.categoryid,target.dataset.categoryid,target.dataset.before,pagecontextid,pending),modal.destroy()})),item.setAttribute("aria-disabled",!1)}))})(pagecontextid)}}));

//# sourceMappingURL=category_list.min.js.map